<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capitalism Station - Interactive RSI Exporter</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            line-height: 1.4;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #00ff00;
            padding-bottom: 20px;
        }
        
        h1 {
            font-size: 2.5em;
            text-shadow: 0 0 10px #00ff00;
            margin-bottom: 10px;
        }
        
        .toolbar {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .toolbar button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .toolbar button:hover {
            background: #00cc00;
            transform: scale(1.05);
        }
        
        .nav-links {
            margin: 20px 0;
            text-align: center;
        }
        
        .nav-links a {
            color: #00ff00;
            text-decoration: none;
            margin: 0 15px;
            font-weight: bold;
            border: 1px solid #00ff00;
            padding: 8px 16px;
            border-radius: 4px;
            transition: all 0.3s;
        }
        
        .nav-links a:hover {
            background: #00ff00;
            color: #000;
        }
        
        .section {
            margin-bottom: 50px;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 20px;
            background: #222;
        }
        
        .section h2 {
            font-size: 1.8em;
            margin-bottom: 20px;
            color: #00ffff;
            text-shadow: 0 0 5px #00ffff;
            border-bottom: 1px solid #00ffff;
            padding-bottom: 10px;
        }
        
        .assets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .asset-card {
            background: #333;
            border: 1px solid #555;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s;
        }
        
        .asset-card:hover {
            border-color: #00ff00;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
        }
        
        .asset-preview {
            width: 64px;
            height: 64px;
            margin: 0 auto 15px;
            background: 
                linear-gradient(45deg, #666 25%, transparent 25%),
                linear-gradient(-45deg, #666 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #666 75%),
                linear-gradient(-45deg, transparent 75%, #666 75%);
            background-size: 8px 8px;
            background-position: 0 0, 0 4px, 4px -4px, -4px 0px;
            border: 1px solid #888;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .asset-preview svg {
            width: 48px;
            height: 48px;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }
        
        .asset-info h3 {
            color: #fff;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .asset-info p {
            color: #ccc;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        
        .asset-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .asset-actions button {
            flex: 1;
            min-width: 120px;
            padding: 8px 12px;
            background: #444;
            color: #fff;
            border: 1px solid #666;
            border-radius: 4px;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9em;
            transition: all 0.3s;
        }
        
        .asset-actions button.png {
            border-color: #ff6b35;
        }
        
        .asset-actions button.png:hover {
            background: #ff6b35;
            color: #000;
        }
        
        .asset-actions button.rsi {
            border-color: #4ecdc4;
        }
        
        .asset-actions button.rsi:hover {
            background: #4ecdc4;
            color: #000;
        }
        
        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            color: #fff;
            padding: 10px 15px;
            border-radius: 4px;
            border-left: 4px solid #00ff00;
            display: none;
            z-index: 1000;
        }
        
        .status.show {
            display: block;
        }
        
        .status.error {
            border-left-color: #ff4444;
            background: #332222;
        }
        
        @media (max-width: 768px) {
            .assets-grid {
                grid-template-columns: 1fr;
            }
            
            .asset-actions {
                flex-direction: column;
            }
            
            .asset-actions button {
                flex: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üè¢ Capitalism Station</h1>
            <p>Interactive RSI Asset Exporter</p>
        </header>
        
        <div class="toolbar">
            <button onclick="downloadAllRSIBundles()" id="downloadAllBtn">
                üì¶ Download ALL .RSI bundles (.zip)
            </button>
        </div>
        
        <nav class="nav-links">
            <a href="#jobs">üëî Jobs</a>
            <a href="#equipment">üîß Equipment</a>
            <a href="#ui">üñ•Ô∏è UI Icons</a>
            <a href="#vfx">‚ú® VFX</a>
        </nav>
        
        <section id="jobs" class="section">
            <h2>üëî Job Icons</h2>
            <p>Corporate job role icons for the capitalism station hierarchy</p>
            <div class="assets-grid" id="jobs-grid">
                <!-- Job assets will be inserted here -->
            </div>
        </section>
        
        <section id="equipment" class="section">
            <h2>üîß Equipment</h2>
            <p>PDAs, tools, and corporate equipment assets</p>
            <div class="assets-grid" id="equipment-grid">
                <!-- Equipment assets will be inserted here -->
            </div>
        </section>
        
        <section id="ui" class="section">
            <h2>üñ•Ô∏è UI Icons</h2>
            <p>User interface elements and economic indicators</p>
            <div class="assets-grid" id="ui-grid">
                <!-- UI assets will be inserted here -->
            </div>
        </section>
        
        <section id="vfx" class="section">
            <h2>‚ú® VFX</h2>
            <p>Visual effects and animated sequences</p>
            <div class="assets-grid" id="vfx-grid">
                <!-- VFX assets will be inserted here -->
            </div>
        </section>
    </div>
    
    <div class="status" id="status"></div>
    
    <script>
        // Asset definitions with inline SVGs
        const ASSET_CATALOG = {
            jobs: [
                {
                    id: 'cfo',
                    name: 'CFO',
                    description: 'Chief Financial Officer - Corporate finance leader',
                    size: { x: 32, y: 32 },
                    svg: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" fill="#2a2a2a"/>
                        <rect x="4" y="4" width="24" height="24" fill="#ffd700" stroke="#000" stroke-width="1"/>
                        <rect x="8" y="8" width="16" height="16" fill="#000"/>
                        <text x="16" y="20" text-anchor="middle" fill="#ffd700" font-family="monospace" font-size="8">$</text>
                        <rect x="12" y="26" width="8" height="2" fill="#ffd700"/>
                    </svg>`
                },
                {
                    id: 'compliance',
                    name: 'Compliance Officer',
                    description: 'Corporate compliance and regulatory oversight',
                    size: { x: 32, y: 32 },
                    svg: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" fill="#2a2a2a"/>
                        <rect x="4" y="4" width="24" height="24" fill="#0066cc" stroke="#000" stroke-width="1"/>
                        <rect x="8" y="8" width="16" height="16" fill="#000"/>
                        <rect x="12" y="12" width="8" height="8" fill="#0066cc"/>
                        <rect x="14" y="14" width="4" height="4" fill="#fff"/>
                        <rect x="10" y="26" width="12" height="2" fill="#0066cc"/>
                    </svg>`
                },
                {
                    id: 'business_dev',
                    name: 'Business Development',
                    description: 'Corporate growth and partnership specialist',
                    size: { x: 32, y: 32 },
                    svg: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" fill="#2a2a2a"/>
                        <rect x="4" y="4" width="24" height="24" fill="#00aa44" stroke="#000" stroke-width="1"/>
                        <rect x="8" y="8" width="16" height="16" fill="#000"/>
                        <polygon points="12,20 16,12 20,20" fill="#00aa44"/>
                        <rect x="15" y="18" width="2" height="6" fill="#00aa44"/>
                        <rect x="11" y="26" width="10" height="2" fill="#00aa44"/>
                    </svg>`
                },
                {
                    id: 'hr',
                    name: 'HR Manager',
                    description: 'Human Resources management and employee relations',
                    size: { x: 32, y: 32 },
                    svg: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" fill="#2a2a2a"/>
                        <rect x="4" y="4" width="24" height="24" fill="#ff6b35" stroke="#000" stroke-width="1"/>
                        <rect x="8" y="8" width="16" height="16" fill="#000"/>
                        <circle cx="16" cy="14" r="3" fill="#ff6b35"/>
                        <rect x="12" y="18" width="8" height="6" fill="#ff6b35"/>
                        <rect x="12" y="26" width="8" height="2" fill="#ff6b35"/>
                    </svg>`
                },
                {
                    id: 'security_analyst',
                    name: 'Security Analyst',
                    description: 'Corporate security and risk assessment',
                    size: { x: 32, y: 32 },
                    svg: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" fill="#2a2a2a"/>
                        <rect x="4" y="4" width="24" height="24" fill="#cc0000" stroke="#000" stroke-width="1"/>
                        <rect x="8" y="8" width="16" height="16" fill="#000"/>
                        <polygon points="16,10 20,16 16,22 12,16" fill="#cc0000"/>
                        <circle cx="16" cy="16" r="2" fill="#000"/>
                        <rect x="13" y="26" width="6" height="2" fill="#cc0000"/>
                    </svg>`
                },
                {
                    id: 'data_analyst',
                    name: 'Data Analyst',
                    description: 'Corporate data analysis and business intelligence',
                    size: { x: 32, y: 32 },
                    svg: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" fill="#2a2a2a"/>
                        <rect x="4" y="4" width="24" height="24" fill="#8a2be2" stroke="#000" stroke-width="1"/>
                        <rect x="8" y="8" width="16" height="16" fill="#000"/>
                        <rect x="10" y="20" width="2" height="4" fill="#8a2be2"/>
                        <rect x="13" y="16" width="2" height="8" fill="#8a2be2"/>
                        <rect x="16" y="12" width="2" height="12" fill="#8a2be2"/>
                        <rect x="19" y="18" width="2" height="6" fill="#8a2be2"/>
                        <rect x="12" y="26" width="8" height="2" fill="#8a2be2"/>
                    </svg>`
                },
                {
                    id: 'intern',
                    name: 'Corporate Intern',
                    description: 'Entry-level corporate intern position',
                    size: { x: 32, y: 32 },
                    svg: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" fill="#2a2a2a"/>
                        <rect x="4" y="4" width="24" height="24" fill="#777777" stroke="#000" stroke-width="1"/>
                        <rect x="8" y="8" width="16" height="16" fill="#000"/>
                        <text x="16" y="18" text-anchor="middle" fill="#777777" font-family="monospace" font-size="6">?</text>
                        <rect x="13" y="26" width="6" height="2" fill="#777777"/>
                    </svg>`
                }
            ],
            equipment: [
                {
                    id: 'cfo_pda',
                    name: 'CFO PDA',
                    description: 'Executive-grade PDA with financial access',
                    size: { x: 32, y: 32 },
                    svg: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" fill="#2a2a2a"/>
                        <rect x="8" y="4" width="16" height="24" fill="#ffd700" stroke="#000" stroke-width="1"/>
                        <rect x="10" y="6" width="12" height="8" fill="#000"/>
                        <rect x="10" y="16" width="12" height="10" fill="#333"/>
                        <rect x="11" y="17" width="2" height="1" fill="#ffd700"/>
                        <rect x="11" y="19" width="2" height="1" fill="#ffd700"/>
                        <rect x="11" y="21" width="2" height="1" fill="#ffd700"/>
                    </svg>`
                },
                {
                    id: 'compliance_pda',
                    name: 'Compliance PDA',
                    description: 'Regulatory compliance monitoring device',
                    size: { x: 32, y: 32 },
                    svg: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" fill="#2a2a2a"/>
                        <rect x="8" y="4" width="16" height="24" fill="#0066cc" stroke="#000" stroke-width="1"/>
                        <rect x="10" y="6" width="12" height="8" fill="#000"/>
                        <rect x="10" y="16" width="12" height="10" fill="#333"/>
                        <rect x="11" y="17" width="2" height="1" fill="#0066cc"/>
                        <rect x="11" y="19" width="2" height="1" fill="#0066cc"/>
                        <rect x="11" y="21" width="2" height="1" fill="#0066cc"/>
                    </svg>`
                },
                {
                    id: 'business_pda',
                    name: 'Business PDA',
                    description: 'Standard business development PDA',
                    size: { x: 32, y: 32 },
                    svg: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" fill="#2a2a2a"/>
                        <rect x="8" y="4" width="16" height="24" fill="#00aa44" stroke="#000" stroke-width="1"/>
                        <rect x="10" y="6" width="12" height="8" fill="#000"/>
                        <rect x="10" y="16" width="12" height="10" fill="#333"/>
                        <rect x="11" y="17" width="2" height="1" fill="#00aa44"/>
                        <rect x="11" y="19" width="2" height="1" fill="#00aa44"/>
                        <rect x="11" y="21" width="2" height="1" fill="#00aa44"/>
                    </svg>`
                },
                {
                    id: 'golden_calculator',
                    name: 'Golden Calculator',
                    description: 'Executive financial calculation device',
                    size: { x: 32, y: 32 },
                    svg: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" fill="#2a2a2a"/>
                        <rect x="6" y="6" width="20" height="20" fill="#ffd700" stroke="#000" stroke-width="1"/>
                        <rect x="8" y="8" width="16" height="6" fill="#000"/>
                        <rect x="8" y="16" width="3" height="2" fill="#333"/>
                        <rect x="12" y="16" width="3" height="2" fill="#333"/>
                        <rect x="16" y="16" width="3" height="2" fill="#333"/>
                        <rect x="20" y="16" width="3" height="2" fill="#333"/>
                        <rect x="8" y="19" width="3" height="2" fill="#333"/>
                        <rect x="12" y="19" width="3" height="2" fill="#333"/>
                        <rect x="16" y="19" width="3" height="2" fill="#333"/>
                        <rect x="20" y="19" width="3" height="4" fill="#00aa44"/>
                    </svg>`
                },
                {
                    id: 'bank_bag',
                    name: 'Bank Security Bag',
                    description: 'Secure transport bag for valuable items',
                    size: { x: 32, y: 32 },
                    svg: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" fill="#2a2a2a"/>
                        <rect x="6" y="10" width="20" height="16" fill="#4a4a4a" stroke="#000" stroke-width="1"/>
                        <rect x="8" y="12" width="16" height="12" fill="#333"/>
                        <rect x="12" y="16" width="8" height="4" fill="#ffd700"/>
                        <rect x="14" y="6" width="4" height="6" fill="#4a4a4a"/>
                        <text x="16" y="19" text-anchor="middle" fill="#000" font-family="monospace" font-size="6">$</text>
                    </svg>`
                }
            ],
            ui: [
                {
                    id: 'credits',
                    name: 'Credits',
                    description: 'Station credit currency icon',
                    size: { x: 32, y: 32 },
                    svg: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" fill="#2a2a2a"/>
                        <circle cx="16" cy="16" r="12" fill="#ffd700" stroke="#000" stroke-width="2"/>
                        <text x="16" y="20" text-anchor="middle" fill="#000" font-family="monospace" font-size="10" font-weight="bold">C</text>
                    </svg>`
                },
                {
                    id: 'social_score',
                    name: 'Social Score',
                    description: 'Social credit score indicator',
                    size: { x: 32, y: 32 },
                    svg: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" fill="#2a2a2a"/>
                        <circle cx="16" cy="16" r="12" fill="#0066cc" stroke="#000" stroke-width="2"/>
                        <text x="16" y="20" text-anchor="middle" fill="#fff" font-family="monospace" font-size="8" font-weight="bold">$</text>
                        <rect x="12" y="10" width="8" height="2" fill="#fff"/>
                    </svg>`
                },
                {
                    id: 'transfer',
                    name: 'Transfer',
                    description: 'Financial transfer action icon',
                    size: { x: 32, y: 32 },
                    svg: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" fill="#2a2a2a"/>
                        <rect x="4" y="12" width="24" height="8" fill="#00aa44" stroke="#000" stroke-width="1"/>
                        <polygon points="22,8 28,16 22,24" fill="#00aa44"/>
                        <rect x="8" y="14" width="12" height="4" fill="#000"/>
                        <text x="14" y="17" text-anchor="middle" fill="#00aa44" font-family="monospace" font-size="6">‚Üí</text>
                    </svg>`
                },
                {
                    id: 'repo',
                    name: 'Repository',
                    description: 'Data repository access icon',
                    size: { x: 32, y: 32 },
                    svg: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" fill="#2a2a2a"/>
                        <rect x="6" y="6" width="20" height="20" fill="#8a2be2" stroke="#000" stroke-width="1"/>
                        <rect x="8" y="8" width="16" height="16" fill="#000"/>
                        <rect x="10" y="10" width="4" height="1" fill="#8a2be2"/>
                        <rect x="10" y="12" width="8" height="1" fill="#8a2be2"/>
                        <rect x="10" y="14" width="6" height="1" fill="#8a2be2"/>
                        <rect x="10" y="16" width="4" height="1" fill="#8a2be2"/>
                        <rect x="10" y="18" width="10" height="1" fill="#8a2be2"/>
                    </svg>`
                },
                {
                    id: 'economic_event',
                    name: 'Economic Event',
                    description: 'Economic event notification icon',
                    size: { x: 32, y: 32 },
                    svg: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" fill="#2a2a2a"/>
                        <polygon points="16,4 20,12 28,12 22,18 24,26 16,22 8,26 10,18 4,12 12,12" fill="#ff6b35" stroke="#000" stroke-width="1"/>
                        <text x="16" y="18" text-anchor="middle" fill="#000" font-family="monospace" font-size="8">!</text>
                    </svg>`
                }
            ],
            vfx: [
                {
                    id: 'credit_gain',
                    name: 'Credit Gain Pulse',
                    description: '8-frame credit gain animation',
                    size: { x: 32, y: 32 },
                    frames: 8,
                    delays: [100, 100, 100, 100, 100, 100, 100, 100],
                    svg: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" fill="#2a2a2a"/>
                        <circle cx="16" cy="16" r="10" fill="#ffd700" stroke="#00ff00" stroke-width="2"/>
                        <text x="16" y="20" text-anchor="middle" fill="#000" font-family="monospace" font-size="10">+</text>
                    </svg>`
                },
                {
                    id: 'social_change',
                    name: 'Social Change Blink',
                    description: '8-frame social score change animation',
                    size: { x: 32, y: 32 },
                    frames: 8,
                    delays: [150, 150, 150, 150, 150, 150, 150, 150],
                    svg: `<svg viewBox="0 0 32 32" xmlns="http://www.w3.org/2000/svg">
                        <rect width="32" height="32" fill="#2a2a2a"/>
                        <circle cx="16" cy="16" r="10" fill="#0066cc" stroke="#ff6b35" stroke-width="2"/>
                        <text x="16" y="20" text-anchor="middle" fill="#fff" font-family="monospace" font-size="8">Œî</text>
                    </svg>`
                }
            ]
        };
        
        // Utility functions for downloads
        function showStatus(message, isError = false) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status show' + (isError ? ' error' : '');
            
            setTimeout(() => {
                status.className = 'status';
            }, 3000);
        }
        
        // CRC32 calculation for ZIP files
        const CRC32_TABLE = (() => {
            const table = new Uint32Array(256);
            for (let i = 0; i < 256; i++) {
                let c = i;
                for (let j = 0; j < 8; j++) {
                    c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) : (c >>> 1);
                }
                table[i] = c;
            }
            return table;
        })();
        
        function crc32(data) {
            let crc = 0xFFFFFFFF;
            const bytes = new Uint8Array(data);
            for (let i = 0; i < bytes.length; i++) {
                crc = CRC32_TABLE[(crc ^ bytes[i]) & 0xFF] ^ (crc >>> 8);
            }
            return (crc ^ 0xFFFFFFFF) >>> 0;
        }
        
        // DOS timestamp conversion
        function toDosDateTime(date = new Date()) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const hour = date.getHours();
            const minute = date.getMinutes();
            const second = Math.floor(date.getSeconds() / 2);
            
            const dosDate = ((year - 1980) << 9) | (month << 5) | day;
            const dosTime = (hour << 11) | (minute << 5) | second;
            
            return { date: dosDate, time: dosTime };
        }
        
        // SVG to PNG conversion
        function svgToPngBytes(svgElement, size = 32) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');
                
                // Enable pixelated rendering
                ctx.imageSmoothingEnabled = false;
                ctx.webkitImageSmoothingEnabled = false;
                ctx.mozImageSmoothingEnabled = false;
                ctx.msImageSmoothingEnabled = false;
                
                const svgData = new XMLSerializer().serializeToString(svgElement);
                const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(svgBlob);
                
                const img = new Image();
                img.onload = () => {
                    ctx.drawImage(img, 0, 0, size, size);
                    URL.revokeObjectURL(url);
                    
                    // Try toBlob first, fallback to toDataURL
                    if (canvas.toBlob) {
                        canvas.toBlob(resolve, 'image/png');
                    } else {
                        // Fallback for older browsers
                        const dataURL = canvas.toDataURL('image/png');
                        const byteString = atob(dataURL.split(',')[1]);
                        const arrayBuffer = new ArrayBuffer(byteString.length);
                        const bytes = new Uint8Array(arrayBuffer);
                        for (let i = 0; i < byteString.length; i++) {
                            bytes[i] = byteString.charCodeAt(i);
                        }
                        resolve(new Blob([bytes], { type: 'image/png' }));
                    }
                };
                img.onerror = reject;
                img.src = url;
            });
        }
        
        // Save blob to file
        function saveBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            // Cleanup
            setTimeout(() => URL.revokeObjectURL(url), 100);
        }
        
        // Generate meta.json for RSI
        function generateMetaJson(asset) {
            const meta = {
                version: 1,
                license: "CC-BY-SA-3.0",
                copyright: "Space Station 14",
                size: asset.size
            };
            
            if (asset.frames && asset.frames > 1) {
                // VFX with multiple frames
                meta.states = [{
                    name: asset.id,
                    delays: asset.delays || Array(asset.frames).fill(100)
                }];
            } else {
                // Single frame
                meta.states = [{ name: asset.id }];
            }
            
            return JSON.stringify(meta, null, 2);
        }
        
        // Build single RSI ZIP
        function buildSingleRSIZip(folderName, asset) {
            return new Promise(async (resolve, reject) => {
                try {
                    const files = [];
                    const now = new Date();
                    const dosDateTime = toDosDateTime(now);
                    
                    // Create meta.json
                    const metaJson = generateMetaJson(asset);
                    const metaBytes = new TextEncoder().encode(metaJson);
                    
                    // Create PNG(s)
                    const svgElement = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    svgElement.innerHTML = asset.svg;
                    
                    let pngFiles = [];
                    
                    if (asset.frames && asset.frames > 1) {
                        // Multiple frames for VFX
                        for (let i = 0; i < asset.frames; i++) {
                            const pngBlob = await svgToPngBytes(svgElement, Math.max(asset.size.x, asset.size.y));
                            const pngBytes = new Uint8Array(await pngBlob.arrayBuffer());
                            pngFiles.push({
                                name: `${asset.id}_${i}.png`,
                                data: pngBytes
                            });
                        }
                    } else {
                        // Single frame
                        const pngBlob = await svgToPngBytes(svgElement, Math.max(asset.size.x, asset.size.y));
                        const pngBytes = new Uint8Array(await pngBlob.arrayBuffer());
                        pngFiles.push({
                            name: `${asset.id}.png`,
                            data: pngBytes
                        });
                    }
                    
                    // Build ZIP file structure
                    const zipData = [];
                    let centralDir = [];
                    let offset = 0;
                    
                    // Add meta.json
                    const metaEntry = buildZipEntry(
                        `${folderName}/meta.json`,
                        metaBytes,
                        dosDateTime,
                        offset
                    );
                    zipData.push(metaEntry.localHeader, metaBytes);
                    centralDir.push(metaEntry.centralDirEntry);
                    offset += metaEntry.localHeader.length + metaBytes.length;
                    
                    // Add PNG files
                    for (const pngFile of pngFiles) {
                        const pngEntry = buildZipEntry(
                            `${folderName}/${pngFile.name}`,
                            pngFile.data,
                            dosDateTime,
                            offset
                        );
                        zipData.push(pngEntry.localHeader, pngFile.data);
                        centralDir.push(pngEntry.centralDirEntry);
                        offset += pngEntry.localHeader.length + pngFile.data.length;
                    }
                    
                    // Build central directory
                    const centralDirData = new Uint8Array(centralDir.reduce((acc, entry) => acc + entry.length, 0));
                    let centralDirOffset = 0;
                    for (const entry of centralDir) {
                        centralDirData.set(entry, centralDirOffset);
                        centralDirOffset += entry.length;
                    }
                    
                    // Build end of central directory record
                    const endOfCentralDir = new Uint8Array(22);
                    const endView = new DataView(endOfCentralDir.buffer);
                    endView.setUint32(0, 0x06054b50, true); // End of central dir signature
                    endView.setUint16(4, 0, true); // Disk number
                    endView.setUint16(6, 0, true); // Central dir start disk
                    endView.setUint16(8, centralDir.length, true); // Number of central dir entries on this disk
                    endView.setUint16(10, centralDir.length, true); // Total number of central dir entries
                    endView.setUint32(12, centralDirData.length, true); // Central dir size
                    endView.setUint32(16, offset, true); // Central dir offset
                    endView.setUint16(20, 0, true); // Comment length
                    
                    // Combine all parts
                    const totalSize = zipData.reduce((acc, part) => acc + part.length, 0) + 
                                     centralDirData.length + endOfCentralDir.length;
                    const result = new Uint8Array(totalSize);
                    let resultOffset = 0;
                    
                    for (const part of zipData) {
                        result.set(part, resultOffset);
                        resultOffset += part.length;
                    }
                    
                    result.set(centralDirData, resultOffset);
                    resultOffset += centralDirData.length;
                    
                    result.set(endOfCentralDir, resultOffset);
                    
                    resolve(new Blob([result], { type: 'application/zip' }));
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        function buildZipEntry(filename, data, dosDateTime, offset) {
            const filenameBytes = new TextEncoder().encode(filename);
            const crc = crc32(data);
            
            // Local file header
            const localHeader = new Uint8Array(30 + filenameBytes.length);
            const localView = new DataView(localHeader.buffer);
            
            localView.setUint32(0, 0x04034b50, true); // Local file header signature
            localView.setUint16(4, 20, true); // Version needed to extract
            localView.setUint16(6, 0, true); // General purpose bit flag
            localView.setUint16(8, 0, true); // Compression method (stored)
            localView.setUint16(10, dosDateTime.time, true); // Last mod file time
            localView.setUint16(12, dosDateTime.date, true); // Last mod file date
            localView.setUint32(14, crc, true); // CRC-32
            localView.setUint32(18, data.length, true); // Compressed size
            localView.setUint32(22, data.length, true); // Uncompressed size
            localView.setUint16(26, filenameBytes.length, true); // File name length
            localView.setUint16(28, 0, true); // Extra field length
            
            // Copy filename
            localHeader.set(filenameBytes, 30);
            
            // Central directory entry
            const centralDirEntry = new Uint8Array(46 + filenameBytes.length);
            const centralView = new DataView(centralDirEntry.buffer);
            
            centralView.setUint32(0, 0x02014b50, true); // Central file header signature
            centralView.setUint16(4, 798, true); // Version made by
            centralView.setUint16(6, 20, true); // Version needed to extract
            centralView.setUint16(8, 0, true); // General purpose bit flag
            centralView.setUint16(10, 0, true); // Compression method (stored)
            centralView.setUint16(12, dosDateTime.time, true); // Last mod file time
            centralView.setUint16(14, dosDateTime.date, true); // Last mod file date
            centralView.setUint32(16, crc, true); // CRC-32
            centralView.setUint32(20, data.length, true); // Compressed size
            centralView.setUint32(24, data.length, true); // Uncompressed size
            centralView.setUint16(28, filenameBytes.length, true); // File name length
            centralView.setUint16(30, 0, true); // Extra field length
            centralView.setUint16(32, 0, true); // File comment length
            centralView.setUint16(34, 0, true); // Disk number start
            centralView.setUint16(36, 0, true); // Internal file attributes
            centralView.setUint32(38, 0, true); // External file attributes
            centralView.setUint32(42, offset, true); // Relative offset of local header
            
            // Copy filename
            centralDirEntry.set(filenameBytes, 46);
            
            return {
                localHeader,
                centralDirEntry
            };
        }
        
        // Download functions
        async function downloadPng(asset) {
            try {
                showStatus(`Generating PNG for ${asset.name}...`);
                
                const svgElement = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svgElement.innerHTML = asset.svg;
                
                const pngBlob = await svgToPngBytes(svgElement, Math.max(asset.size.x, asset.size.y));
                saveBlob(pngBlob, `${asset.id}.png`);
                
                showStatus(`‚úÖ Downloaded ${asset.name}.png`);
            } catch (error) {
                console.error('PNG download error:', error);
                showStatus(`‚ùå Failed to download PNG: ${error.message}`, true);
            }
        }
        
        async function downloadRsi(asset) {
            try {
                showStatus(`Building RSI for ${asset.name}...`);
                
                const rsiBlob = await buildSingleRSIZip(asset.id, asset);
                saveBlob(rsiBlob, `${asset.id}.rsi.zip`);
                
                showStatus(`‚úÖ Downloaded ${asset.name}.rsi.zip`);
            } catch (error) {
                console.error('RSI download error:', error);
                showStatus(`‚ùå Failed to download RSI: ${error.message}`, true);
            }
        }
        
        async function downloadAllRSIBundles() {
            try {
                showStatus('Building master RSI bundle...');
                const btn = document.getElementById('downloadAllBtn');
                btn.disabled = true;
                btn.textContent = 'Building...';
                
                const allFiles = [];
                const now = new Date();
                const dosDateTime = toDosDateTime(now);
                
                // Process all assets
                for (const [category, assets] of Object.entries(ASSET_CATALOG)) {
                    for (const asset of assets) {
                        const folderName = `${category}/${asset.id}`;
                        
                        // Add meta.json
                        const metaJson = generateMetaJson(asset);
                        const metaBytes = new TextEncoder().encode(metaJson);
                        allFiles.push({
                            name: `${folderName}/meta.json`,
                            data: metaBytes
                        });
                        
                        // Add PNG(s)
                        const svgElement = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                        svgElement.innerHTML = asset.svg;
                        
                        if (asset.frames && asset.frames > 1) {
                            for (let i = 0; i < asset.frames; i++) {
                                const pngBlob = await svgToPngBytes(svgElement, Math.max(asset.size.x, asset.size.y));
                                const pngBytes = new Uint8Array(await pngBlob.arrayBuffer());
                                allFiles.push({
                                    name: `${folderName}/${asset.id}_${i}.png`,
                                    data: pngBytes
                                });
                            }
                        } else {
                            const pngBlob = await svgToPngBytes(svgElement, Math.max(asset.size.x, asset.size.y));
                            const pngBytes = new Uint8Array(await pngBlob.arrayBuffer());
                            allFiles.push({
                                name: `${folderName}/${asset.id}.png`,
                                data: pngBytes
                            });
                        }
                    }
                }
                
                // Build master ZIP
                const zipData = [];
                let centralDir = [];
                let offset = 0;
                
                for (const file of allFiles) {
                    const entry = buildZipEntry(file.name, file.data, dosDateTime, offset);
                    zipData.push(entry.localHeader, file.data);
                    centralDir.push(entry.centralDirEntry);
                    offset += entry.localHeader.length + file.data.length;
                }
                
                // Build central directory
                const centralDirData = new Uint8Array(centralDir.reduce((acc, entry) => acc + entry.length, 0));
                let centralDirOffset = 0;
                for (const entry of centralDir) {
                    centralDirData.set(entry, centralDirOffset);
                    centralDirOffset += entry.length;
                }
                
                // Build end of central directory record
                const endOfCentralDir = new Uint8Array(22);
                const endView = new DataView(endOfCentralDir.buffer);
                endView.setUint32(0, 0x06054b50, true);
                endView.setUint16(8, centralDir.length, true);
                endView.setUint16(10, centralDir.length, true);
                endView.setUint32(12, centralDirData.length, true);
                endView.setUint32(16, offset, true);
                
                // Combine all parts
                const totalSize = zipData.reduce((acc, part) => acc + part.length, 0) + 
                                 centralDirData.length + endOfCentralDir.length;
                const result = new Uint8Array(totalSize);
                let resultOffset = 0;
                
                for (const part of zipData) {
                    result.set(part, resultOffset);
                    resultOffset += part.length;
                }
                result.set(centralDirData, resultOffset);
                result.set(endOfCentralDir, resultOffset + centralDirData.length);
                
                const masterBlob = new Blob([result], { type: 'application/zip' });
                saveBlob(masterBlob, 'capitalism-station-all-rsi-bundles.zip');
                
                showStatus(`‚úÖ Downloaded master RSI bundle with ${allFiles.length} files`);
            } catch (error) {
                console.error('Master bundle error:', error);
                showStatus(`‚ùå Failed to build master bundle: ${error.message}`, true);
            } finally {
                const btn = document.getElementById('downloadAllBtn');
                btn.disabled = false;
                btn.textContent = 'üì¶ Download ALL .RSI bundles (.zip)';
            }
        }
        
        // Render asset cards
        function renderAssets() {
            for (const [category, assets] of Object.entries(ASSET_CATALOG)) {
                const grid = document.getElementById(`${category}-grid`);
                if (!grid) continue;
                
                assets.forEach(asset => {
                    const card = document.createElement('div');
                    card.className = 'asset-card';
                    
                    card.innerHTML = `
                        <div class="asset-preview">
                            ${asset.svg}
                        </div>
                        <div class="asset-info">
                            <h3>${asset.name}</h3>
                            <p>${asset.description}</p>
                            <div class="asset-actions">
                                <button class="png" onclick="downloadPng(ASSET_CATALOG.${category}.find(a => a.id === '${asset.id}'))">
                                    Download PNG
                                </button>
                                <button class="rsi" onclick="downloadRsi(ASSET_CATALOG.${category}.find(a => a.id === '${asset.id}'))">
                                    Download .RSI (.zip)
                                </button>
                            </div>
                        </div>
                    `;
                    
                    grid.appendChild(card);
                });
            }
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            renderAssets();
            showStatus('üöÄ RSI Exporter ready!');
        });
        
        // Handle navigation
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
    </script>
</body>
</html>